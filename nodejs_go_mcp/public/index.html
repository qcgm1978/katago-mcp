<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>围棋分析助手</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background-color: #4a6fa5;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .chat-container {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease-in;
        }
        .message.user .content {
            background-color: #e3f2fd;
            color: #0d47a1;
            border-radius: 18px 18px 0 18px;
            margin-left: auto;
        }
        .message.assistant .content {
            background-color: #f5f5f5;
            color: #333;
            border-radius: 18px 18px 18px 0;
        }
        .message.system .content {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-radius: 12px;
            text-align: center;
            font-style: italic;
        }
        .message .content {
            max-width: 80%;
            padding: 12px 16px;
            word-wrap: break-word;
        }
        .input-container {
            padding: 20px;
            background-color: #fafafa;
            display: flex;
            gap: 10px;
        }
        .sgf-upload-button {
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 24px;
            padding: 12px 16px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .sgf-upload-button:hover {
            background-color: #45a049;
        }
        #sgf-file {
            display: none;
        }
        #message-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 24px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        #message-input:focus {
            border-color: #4a6fa5;
        }
        #send-button {
            padding: 12px 24px;
            background-color: #4a6fa5;
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #send-button:hover {
            background-color: #3a5a85;
        }
        #send-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .thinking-indicator {
            text-align: center;
            padding: 10px;
            color: #666;
            font-style: italic;
        }
        .code-block {
            background-color: #f1f1f1;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .help-text {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .help-text h4 {
            margin-top: 0;
            color: #856404;
        }
        .help-text ul {
            margin: 10px 0;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>围棋分析助手</h1>
            <p>使用LLM和MCP协议的围棋AI分析工具</p>
        </div>
        
        <div class="chat-container" id="chat-container">
            <div class="message system">
                <div class="content">
                    欢迎使用围棋分析助手！请先配置DeepSeek API密钥。
                </div>
            </div>
            
            <div id="api-key-config" class="help-text" style="margin: 20px;">
                <h4>配置DeepSeek API密钥</h4>
                <p>请输入您的DeepSeek API密钥以启用分析功能：</p>
                <input type="password" id="api-key-input" placeholder="输入DeepSeek API密钥" style="width: 100%; padding: 10px; margin-bottom: 10px;">
                <button id="save-api-key-btn" style="background-color: #4a6fa5; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">保存密钥</button>
                <div id="api-key-status" style="margin-top: 10px; font-size: 14px;"></div>
            </div>
            
            <div class="help-text">
                <h4>使用帮助：</h4>
                <ul>
                    <li>分析局面：发送走法，如 "分析局面 B16 W17 B15"</li>
                    <li>查看棋盘：发送 "显示当前棋盘"</li>
                    <li>加载SGF：使用上方的上传按钮</li>
                    <li>提问：如 "这个局面黑棋有什么好的下法？"</li>
                </ul>
            </div>
        </div>
        
        <div class="input-container">
            <input type="text" id="message-input" placeholder="输入您的问题或命令..." autofocus>
            <button id="send-button">发送</button>
            <button class="sgf-upload-button" id="upload-sgf-button">上传SGF</button>
            <input type="file" id="sgf-file" accept=".sgf">
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        let ws = null;
        let thinkingIndicator = null;

        // 连接WebSocket
        function connectWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = wsProtocol + '//' + window.location.host;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('WebSocket连接已建立');
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (error) {
                    console.error('解析消息失败:', error);
                }
            };
            
            ws.onclose = () => {
                console.log('WebSocket连接已关闭');
                // 尝试重连
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket错误:', error);
            };
        }

        // 处理API认证失败的情况
        function handleApiAuthFailure() {
            // 显示API密钥配置区域
            const configElement = document.getElementById('api-key-config');
            const statusElement = document.getElementById('api-key-status');
            
            if (configElement && statusElement) {
                configElement.style.display = 'block';
                statusElement.textContent = 'API密钥无效或已过期，请重新输入';
                statusElement.style.color = '#f44336';
                
                // 清空输入框
                const apiKeyInput = document.getElementById('api-key-input');
                if (apiKeyInput) {
                    apiKeyInput.value = '';
                    apiKeyInput.focus();
                }
                
                // 发送一条系统消息提示用户
                addMessage('system', '⚠️ DeepSeek API认证失败，请重新配置API密钥');
            }
        }
        
        // 处理接收到的消息
        function handleMessage(data) {
            if (thinkingIndicator) {
                chatContainer.removeChild(thinkingIndicator);
                thinkingIndicator = null;
            }
            
            if (data.type === 'assistant_message') {
                addMessage('assistant', data.message);
            } else if (data.type === 'system') {
                addMessage('system', data.message);
            } else if (data.type === 'error') {
                const errorMessage = '错误: ' + data.message;
                addMessage('system', errorMessage);
                
                // 检查是否为API认证失败错误
                if (data.message && (data.message.includes('API认证失败') || 
                                     data.message.includes('API密钥无效') || 
                                     data.message.includes('401'))) {
                    handleApiAuthFailure();
                }
            } else if (data.type === 'thinking') {
                showThinkingIndicator();
            }
        }

        // 添加消息到聊天界面
        function addMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + role;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'content';
            
            // 简单处理内容，避免复杂的字符串操作
            contentDiv.textContent = content;
            
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            
            // 滚动到底部
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // 启用发送按钮
            sendButton.disabled = false;
        }

        // 显示思考指示器
        function showThinkingIndicator() {
            thinkingIndicator = document.createElement('div');
            thinkingIndicator.className = 'thinking-indicator';
            thinkingIndicator.textContent = '助手正在思考...';
            chatContainer.appendChild(thinkingIndicator);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 发送消息
        function sendMessage() {
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            // 添加用户消息到界面
            addMessage('user', message);
            
            // 清空输入框
            messageInput.value = '';
            
            // 禁用发送按钮
            sendButton.disabled = true;
            
            // 通过WebSocket发送消息
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'user_message',
                    content: message
                }));
            } else {
                // 如果WebSocket未连接，使用HTTP API作为后备
                sendViaHttp(message);
            }
        }

        // 通过HTTP API发送消息（WebSocket后备方案）
        async function sendViaHttp(message) {
            try {
                showThinkingIndicator();
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: message })
                });
                
                if (!response.ok) {
                    throw new Error('服务器错误');
                }
                
                const data = await response.json();
                addMessage('assistant', data.response);
            } catch (error) {
                const errorMessage = '发送失败: ' + error.message;
                addMessage('system', errorMessage);
                
                // 检查是否为API认证失败错误
                if (error.message && (error.message.includes('API认证失败') || 
                                     error.message.includes('API密钥无效') || 
                                     error.message.includes('401'))) {
                    handleApiAuthFailure();
                }
            }
        }

        // 事件监听器
        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        // 检查API密钥状态
        async function checkApiKeyStatus() {
            try {
                const response = await fetch('/api/check-api-key');
                const data = await response.json();
                const statusElement = document.getElementById('api-key-status');
                const configElement = document.getElementById('api-key-config');
                
                if (data.hasValidKey) {
                    statusElement.textContent = 'API密钥已配置';
                    statusElement.style.color = '#4caf50';
                    configElement.style.display = 'none';
                } else {
                    statusElement.textContent = '请配置API密钥';
                    statusElement.style.color = '#f44336';
                    configElement.style.display = 'block';
                }
            } catch (error) {
                console.error('检查API密钥状态失败:', error);
            }
        }
        
        // 保存API密钥
        document.getElementById('save-api-key-btn').addEventListener('click', async function() {
            const apiKeyInput = document.getElementById('api-key-input');
            const apiKey = apiKeyInput.value.trim();
            const statusElement = document.getElementById('api-key-status');
            
            if (!apiKey) {
                statusElement.textContent = 'API密钥不能为空';
                statusElement.style.color = '#f44336';
                return;
            }
            
            try {
                const response = await fetch('/api/save-api-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ apiKey })
                });
                
                const data = await response.json();
                
                if (data.success) {
                     statusElement.textContent = 'API密钥已保存并生效';
                     statusElement.style.color = '#4caf50';
                     document.getElementById('api-key-config').style.display = 'none';
                     apiKeyInput.value = '';
                     addMessage('system', 'API密钥已成功配置！现在您可以开始使用分析功能。');
                 } else {
                     statusElement.textContent = '保存失败: ' + (data.error || '未知错误');
                     statusElement.style.color = '#f44336';
                 }
            } catch (error) {
                statusElement.textContent = '保存失败: ' + error.message;
                statusElement.style.color = '#f44336';
            }
        });
        
        // 处理SGF文件上传
        document.getElementById('upload-sgf-button').addEventListener('click', function() {
            document.getElementById('sgf-file').click();
        });
        
        document.getElementById('sgf-file').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            addMessage('user', '上传SGF文件: ' + file.name);
            
            try {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const sgfContent = event.target.result;
                    
                    // 发送SGF内容到服务器
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        showThinkingIndicator();
                        ws.send(JSON.stringify({
                            type: 'user_message',
                            content: '分析SGF: ' + sgfContent
                        }));
                    } else {
                        // 使用HTTP API作为后备
                        sendSgfViaHttp(sgfContent);
                    }
                };
                reader.readAsText(file);
            } catch (error) {
                addMessage('system', '读取SGF文件失败: ' + error.message);
            }
            
            // 清空文件输入，允许再次上传同一文件
            this.value = '';
        });
        
        // 通过HTTP API发送SGF内容
        async function sendSgfViaHttp(sgfContent) {
            try {
                showThinkingIndicator();
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: '分析SGF: ' + sgfContent })
                });
                
                if (!response.ok) {
                    throw new Error('服务器错误');
                }
                
                const data = await response.json();
                addMessage('assistant', data.response);
            } catch (error) {
                addMessage('system', '发送SGF内容失败: ' + error.message);
            }
        }
        
        // 初始化
        checkApiKeyStatus();
        connectWebSocket();
    </script>
</body>
</html>